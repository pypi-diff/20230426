# Comparing `tmp/finlab-0.4.1-cp39-cp39-win_amd64.whl.zip` & `tmp/finlab-0.4.2-cp39-cp39-win_amd64.whl.zip`

## zipinfo {}

```diff
@@ -1,47 +1,48 @@
-Zip file size: 391402 bytes, number of entries: 45
--rw-rw-rw-  2.0 fat     2450 b- defN 23-Apr-13 21:37 finlab/__init__.py
--rw-rw-rw-  2.0 fat   206848 b- defN 23-Apr-13 21:41 finlab/aes.cp39-win_amd64.pyd
--rw-rw-rw-  2.0 fat    22598 b- defN 23-Apr-13 21:37 finlab/backtest.py
--rw-rw-rw-  2.0 fat   133632 b- defN 23-Apr-13 21:41 finlab/backtest_core.cp39-win_amd64.pyd
--rw-rw-rw-  2.0 fat     1424 b- defN 23-Apr-13 21:37 finlab/backtest_old.py
--rw-rw-rw-  2.0 fat      915 b- defN 23-Apr-13 21:37 finlab/cells.py
--rw-rw-rw-  2.0 fat    29089 b- defN 23-Apr-13 21:37 finlab/data.py
--rw-rw-rw-  2.0 fat    29056 b- defN 23-Apr-13 21:37 finlab/dataframe.py
--rw-rw-rw-  2.0 fat    80750 b- defN 23-Apr-13 21:37 finlab/ffn_core.py
--rw-rw-rw-  2.0 fat    73216 b- defN 23-Apr-13 21:41 finlab/mae_mfe.cp39-win_amd64.pyd
--rw-rw-rw-  2.0 fat      460 b- defN 23-Apr-13 21:37 finlab/mae_mfe.pxd
--rw-rw-rw-  2.0 fat     3757 b- defN 23-Apr-13 21:37 finlab/market_info.py
--rw-rw-rw-  2.0 fat    36059 b- defN 23-Apr-13 21:37 finlab/plot.py
--rw-rw-rw-  2.0 fat   166912 b- defN 23-Apr-13 21:41 finlab/report.cp39-win_amd64.pyd
--rw-rw-rw-  2.0 fat     5132 b- defN 23-Apr-13 21:37 finlab/utils.py
--rw-rw-rw-  2.0 fat    19968 b- defN 23-Apr-13 21:41 finlab/utils_core.cp39-win_amd64.pyd
--rw-rw-rw-  2.0 fat     7287 b- defN 23-Apr-13 21:37 finlab/analysis/__init__.py
--rw-rw-rw-  2.0 fat     1988 b- defN 23-Apr-13 21:37 finlab/analysis/alphaBetaAnalysis.py
--rw-rw-rw-  2.0 fat     1449 b- defN 23-Apr-13 21:37 finlab/analysis/drawdownAnalysis.py
--rw-rw-rw-  2.0 fat     5007 b- defN 23-Apr-13 21:37 finlab/analysis/inequalityAnalysis.py
--rw-rw-rw-  2.0 fat     4626 b- defN 23-Apr-13 21:37 finlab/analysis/liquidityAnalysis.py
--rw-rw-rw-  2.0 fat    12343 b- defN 23-Apr-13 21:37 finlab/analysis/maeMfeAnalysis.py
--rw-rw-rw-  2.0 fat     3618 b- defN 23-Apr-13 21:37 finlab/analysis/periodStatsAnalysis.py
--rw-rw-rw-  2.0 fat      704 b- defN 23-Apr-13 21:37 finlab/ml/__init__.py
--rw-rw-rw-  2.0 fat    15448 b- defN 23-Apr-13 21:37 finlab/ml/feature.py
--rw-rw-rw-  2.0 fat     2404 b- defN 23-Apr-13 21:37 finlab/ml/label.py
--rw-rw-rw-  2.0 fat    17707 b- defN 23-Apr-13 21:37 finlab/ml/qlib.py
--rw-rw-rw-  2.0 fat     3131 b- defN 23-Apr-13 21:37 finlab/ml/utils.py
--rw-rw-rw-  2.0 fat        0 b- defN 23-Apr-13 21:37 finlab/online/__init__.py
--rw-rw-rw-  2.0 fat     8155 b- defN 23-Apr-13 21:37 finlab/online/base_account.py
--rw-rw-rw-  2.0 fat    12766 b- defN 23-Apr-13 21:37 finlab/online/binance_account.py
--rw-rw-rw-  2.0 fat     7264 b- defN 23-Apr-13 21:37 finlab/online/dashboard.py
--rw-rw-rw-  2.0 fat      263 b- defN 23-Apr-13 21:37 finlab/online/enums.py
--rw-rw-rw-  2.0 fat    12844 b- defN 23-Apr-13 21:37 finlab/online/fugle_account.py
--rw-rw-rw-  2.0 fat    17102 b- defN 23-Apr-13 21:37 finlab/online/order_executor.py
--rw-rw-rw-  2.0 fat    13122 b- defN 23-Apr-13 21:37 finlab/online/panel.py
--rw-rw-rw-  2.0 fat     8537 b- defN 23-Apr-13 21:37 finlab/online/sinopac_account.py
--rw-rw-rw-  2.0 fat     5432 b- defN 23-Apr-13 21:37 finlab/online/utils.py
--rw-rw-rw-  2.0 fat        0 b- defN 23-Apr-13 21:37 finlab/optimize/__init__.py
--rw-rw-rw-  2.0 fat     8815 b- defN 23-Apr-13 21:37 finlab/optimize/combinations.py
--rw-rw-rw-  2.0 fat    35823 b- defN 23-Apr-13 21:41 finlab-0.4.1.dist-info/LICENSE
--rw-rw-rw-  2.0 fat     3787 b- defN 23-Apr-13 21:41 finlab-0.4.1.dist-info/METADATA
--rw-rw-rw-  2.0 fat      100 b- defN 23-Apr-13 21:41 finlab-0.4.1.dist-info/WHEEL
--rw-rw-rw-  2.0 fat        7 b- defN 23-Apr-13 21:41 finlab-0.4.1.dist-info/top_level.txt
--rw-rw-r--  2.0 fat     3698 b- defN 23-Apr-13 21:41 finlab-0.4.1.dist-info/RECORD
-45 files, 1025693 bytes uncompressed, 385600 bytes compressed:  62.4%
+Zip file size: 393118 bytes, number of entries: 46
+-rw-rw-rw-  2.0 fat     2450 b- defN 23-Apr-26 14:01 finlab/__init__.py
+-rw-rw-rw-  2.0 fat   206848 b- defN 23-Apr-26 14:06 finlab/aes.cp39-win_amd64.pyd
+-rw-rw-rw-  2.0 fat    22767 b- defN 23-Apr-26 14:01 finlab/backtest.py
+-rw-rw-rw-  2.0 fat   133120 b- defN 23-Apr-26 14:06 finlab/backtest_core.cp39-win_amd64.pyd
+-rw-rw-rw-  2.0 fat     1424 b- defN 23-Apr-26 14:01 finlab/backtest_old.py
+-rw-rw-rw-  2.0 fat      915 b- defN 23-Apr-26 14:01 finlab/cells.py
+-rw-rw-rw-  2.0 fat    29089 b- defN 23-Apr-26 14:01 finlab/data.py
+-rw-rw-rw-  2.0 fat    29113 b- defN 23-Apr-26 14:01 finlab/dataframe.py
+-rw-rw-rw-  2.0 fat    80750 b- defN 23-Apr-26 14:01 finlab/ffn_core.py
+-rw-rw-rw-  2.0 fat    71680 b- defN 23-Apr-26 14:06 finlab/mae_mfe.cp39-win_amd64.pyd
+-rw-rw-rw-  2.0 fat      460 b- defN 23-Apr-26 14:01 finlab/mae_mfe.pxd
+-rw-rw-rw-  2.0 fat     5105 b- defN 23-Apr-26 14:01 finlab/market_info.py
+-rw-rw-rw-  2.0 fat    36257 b- defN 23-Apr-26 14:01 finlab/plot.py
+-rw-rw-rw-  2.0 fat   167424 b- defN 23-Apr-26 14:06 finlab/report.cp39-win_amd64.pyd
+-rw-rw-rw-  2.0 fat     5132 b- defN 23-Apr-26 14:01 finlab/utils.py
+-rw-rw-rw-  2.0 fat    19968 b- defN 23-Apr-26 14:06 finlab/utils_core.cp39-win_amd64.pyd
+-rw-rw-rw-  2.0 fat     7287 b- defN 23-Apr-26 14:01 finlab/analysis/__init__.py
+-rw-rw-rw-  2.0 fat     1988 b- defN 23-Apr-26 14:01 finlab/analysis/alphaBetaAnalysis.py
+-rw-rw-rw-  2.0 fat     1449 b- defN 23-Apr-26 14:01 finlab/analysis/drawdownAnalysis.py
+-rw-rw-rw-  2.0 fat     5007 b- defN 23-Apr-26 14:01 finlab/analysis/inequalityAnalysis.py
+-rw-rw-rw-  2.0 fat     4626 b- defN 23-Apr-26 14:01 finlab/analysis/liquidityAnalysis.py
+-rw-rw-rw-  2.0 fat    12343 b- defN 23-Apr-26 14:01 finlab/analysis/maeMfeAnalysis.py
+-rw-rw-rw-  2.0 fat     3618 b- defN 23-Apr-26 14:01 finlab/analysis/periodStatsAnalysis.py
+-rw-rw-rw-  2.0 fat      704 b- defN 23-Apr-26 14:01 finlab/ml/__init__.py
+-rw-rw-rw-  2.0 fat     3879 b- defN 23-Apr-26 14:01 finlab/ml/alphalens.py
+-rw-rw-rw-  2.0 fat    15609 b- defN 23-Apr-26 14:01 finlab/ml/feature.py
+-rw-rw-rw-  2.0 fat     2559 b- defN 23-Apr-26 14:01 finlab/ml/label.py
+-rw-rw-rw-  2.0 fat    18065 b- defN 23-Apr-26 14:01 finlab/ml/qlib.py
+-rw-rw-rw-  2.0 fat     3131 b- defN 23-Apr-26 14:01 finlab/ml/utils.py
+-rw-rw-rw-  2.0 fat        0 b- defN 23-Apr-26 14:01 finlab/online/__init__.py
+-rw-rw-rw-  2.0 fat     8155 b- defN 23-Apr-26 14:01 finlab/online/base_account.py
+-rw-rw-rw-  2.0 fat    12766 b- defN 23-Apr-26 14:01 finlab/online/binance_account.py
+-rw-rw-rw-  2.0 fat     7264 b- defN 23-Apr-26 14:01 finlab/online/dashboard.py
+-rw-rw-rw-  2.0 fat      263 b- defN 23-Apr-26 14:01 finlab/online/enums.py
+-rw-rw-rw-  2.0 fat    12844 b- defN 23-Apr-26 14:01 finlab/online/fugle_account.py
+-rw-rw-rw-  2.0 fat    17131 b- defN 23-Apr-26 14:01 finlab/online/order_executor.py
+-rw-rw-rw-  2.0 fat    13122 b- defN 23-Apr-26 14:01 finlab/online/panel.py
+-rw-rw-rw-  2.0 fat     8537 b- defN 23-Apr-26 14:01 finlab/online/sinopac_account.py
+-rw-rw-rw-  2.0 fat     5432 b- defN 23-Apr-26 14:01 finlab/online/utils.py
+-rw-rw-rw-  2.0 fat        0 b- defN 23-Apr-26 14:01 finlab/optimize/__init__.py
+-rw-rw-rw-  2.0 fat     8815 b- defN 23-Apr-26 14:01 finlab/optimize/combinations.py
+-rw-rw-rw-  2.0 fat    35823 b- defN 23-Apr-26 14:06 finlab-0.4.2.dist-info/LICENSE
+-rw-rw-rw-  2.0 fat     3879 b- defN 23-Apr-26 14:06 finlab-0.4.2.dist-info/METADATA
+-rw-rw-rw-  2.0 fat      100 b- defN 23-Apr-26 14:06 finlab-0.4.2.dist-info/WHEEL
+-rw-rw-rw-  2.0 fat        7 b- defN 23-Apr-26 14:06 finlab-0.4.2.dist-info/top_level.txt
+-rw-rw-r--  2.0 fat     3777 b- defN 23-Apr-26 14:06 finlab-0.4.2.dist-info/RECORD
+46 files, 1030682 bytes uncompressed, 387196 bytes compressed:  62.4%
```

## zipnote {}

```diff
@@ -66,14 +66,17 @@
 
 Filename: finlab/analysis/periodStatsAnalysis.py
 Comment: 
 
 Filename: finlab/ml/__init__.py
 Comment: 
 
+Filename: finlab/ml/alphalens.py
+Comment: 
+
 Filename: finlab/ml/feature.py
 Comment: 
 
 Filename: finlab/ml/label.py
 Comment: 
 
 Filename: finlab/ml/qlib.py
@@ -114,23 +117,23 @@
 
 Filename: finlab/optimize/__init__.py
 Comment: 
 
 Filename: finlab/optimize/combinations.py
 Comment: 
 
-Filename: finlab-0.4.1.dist-info/LICENSE
+Filename: finlab-0.4.2.dist-info/LICENSE
 Comment: 
 
-Filename: finlab-0.4.1.dist-info/METADATA
+Filename: finlab-0.4.2.dist-info/METADATA
 Comment: 
 
-Filename: finlab-0.4.1.dist-info/WHEEL
+Filename: finlab-0.4.2.dist-info/WHEEL
 Comment: 
 
-Filename: finlab-0.4.1.dist-info/top_level.txt
+Filename: finlab-0.4.2.dist-info/top_level.txt
 Comment: 
 
-Filename: finlab-0.4.1.dist-info/RECORD
+Filename: finlab-0.4.2.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## finlab/__init__.py

```diff
@@ -7,15 +7,15 @@
 from getpass import getpass
 
 
 # Get an instance of a logger
 logging.basicConfig(level=logging.INFO)
 logger = logging.getLogger(__name__)
 
-__version__ = '0.4.1'
+__version__ = '0.4.2'
 
 
 class LoginPanel():
 
     def __init__(self):
         pass
```

## finlab/backtest.py

```diff
@@ -192,21 +192,25 @@
 
     # check version
     check_version()
 
     # auto detect market type
     if market == 'AUTO':
         if isinstance(trade_at_price, str):
-            market = 'TW_STOCK'
+            if position.columns[0].isdigit():
+                market = 'TW_STOCK'
+            else:
+                market = 'US_STOCK'
 
     # get market position according to market type
     if isinstance(market, str):
-        assert market in ['TW_STOCK', 'AUTO']
+        assert market in ['TW_STOCK','US_STOCK', 'AUTO']
         market = {
             'TW_STOCK': market_info.TWMarketInfo,
+            'US_STOCK': market_info.USMarketInfo,
             'AUTO': market_info.MarketInfo
         }[market]
 
     # determine trading price
     price = trade_at_price
     if isinstance(trade_at_price, str):
         price = market.get_price(trade_at_price, adj=True)
```

## finlab/dataframe.py

```diff
@@ -619,14 +619,15 @@
         if stop_loss != -np.inf or take_profit != np.inf:
             price = data.get(f'etl:adj_{trade_at}')
             union_index = union_index.union(
                 price.loc[union_index[0]: union_index[-1]].index)
             intersect_col = intersect_col.intersection(price.columns)
         else:
             price = pd.DataFrame()
+            price.index = pd.to_datetime(price.index)
 
         if rank is not None:
             union_index = union_index.union(rank.index)
             intersect_col = intersect_col.intersection(rank.columns)
 
         entry = self.reindex(union_index, columns=intersect_col,
                              method='ffill').ffill().fillna(False)
@@ -698,15 +699,15 @@
                             price=price.values,
                             ranking=rank.values)
 
         return pd.DataFrame(ret, index=entry.index, columns=entry.columns)
 
 
 
-@functools.lru_cache
+@functools.lru_cache()
 def calc_disclosure_dates(detail=True):
 
   cinfo = data.get('company_basic_info').copy()
   cinfo['id'] = cinfo.stock_id.str.split(' ').str[0]
   cinfo = cinfo.set_index('id')
   cinfo = cinfo[~cinfo.index.duplicated(keep='last')]
```

## finlab/market_info.py

```diff
@@ -107,7 +107,51 @@
                 price_name = {'open': '開盤價', 'close': '收盤價', 'high': '最高價', 'low': '最低價'}[trade_at_price]
 
             price = finlab.data.get(f'{table_name}{price_name}')
             return price
 
         raise Exception(f'**ERROR: trade_at_price is not allowed (accepted types: pd.DataFrame, pd.Series, str).')
 
+class USMarketInfo(MarketInfo):
+
+    @staticmethod
+    def get_freq():
+        return '1d'
+
+    @staticmethod
+    def get_timestamp_name():
+        return 'us_stock'
+
+    @staticmethod
+    def get_benchmark():
+        return finlab.data.get('world_index:adj_close')['^GSPC']
+
+    @staticmethod
+    def get_asset_id_to_name():
+        categories = finlab.data.get('us_tickers')
+        stock_names = dict(
+            zip(categories['stock_id'], categories['name']))
+        return stock_names
+
+    @staticmethod
+    def get_price(trade_at_price, adj=True):
+        if isinstance(trade_at_price, pd.Series):
+            return trade_at_price.to_frame()
+
+        if isinstance(trade_at_price, pd.DataFrame):
+            return trade_at_price
+
+        if isinstance(trade_at_price, str):
+            if trade_at_price == 'volume':
+                return finlab.data.get('us_price:volume')
+
+            if adj:
+                table_name = 'us_price:adj_'
+                price_name = trade_at_price
+            else:
+                table_name = 'us_price:'
+                price_name = trade_at_price
+
+            price = finlab.data.get(f'{table_name}{price_name}')
+            return price
+
+        raise Exception(f'**ERROR: trade_at_price is not allowed (accepted types: pd.DataFrame, pd.Series, str).')
```

## finlab/plot.py

```diff
@@ -560,15 +560,15 @@
 
 
 """
 Radar
 """
 
 
-def plot_radar(df, mode='line_polar', line_polar_fill=None, title=None, polar_range=10):
+def plot_radar(df, mode='bar_polar', line_polar_fill=None, title=None, polar_range=10):
     args = dict(data_frame=df, r="value", theta="variable", color="stock_id", line_close=True,
                 color_discrete_sequence=px.colors.sequential.Plasma_r,
                 template="plotly_dark")
     if mode != 'line_polar':
         args.pop('line_close')
 
     fig = getattr(px, mode)(**args)
@@ -621,22 +621,23 @@
 
     比較持股組合的指標分級特性。若數值為nan，則不顯示分級。
 
     Args:
       portfolio (list):持股組合，ex:`['1101','1102']`。
       feats (list): 選定FinLab資料庫內的指標組成資料集。預設為18項財務指標。
                     ex:['fundamental_features:營業毛利率','fundamental_features:營業利益率']
-      mode (str): 雷達圖模式 ，ex:`'line_polar','bar_polar','scatter_polar'`。
+      mode (str): 雷達圖模式 ，ex:'bar_polar','scatter_polar','line_polar'`。
         !!!note
 
             參考[不同模式的差異](https://plotly.com/python-api-reference/generated/plotly.express.html)
       line_polar_fill (str):將區域設置為用純色填充 。ex:`None,'toself','tonext'`
                            `'toself'`將跡線的端點（或跡線的每一段，如果它有間隙）連接成一個封閉的形狀。
                            如果一條完全包圍另一條（例如連續的等高線），則`'tonext'`填充兩條跡線之間的空間，如果之前沒有跡線，
                            則其行為類似於`'toself'`。如果一條跡線不包含另一條跡線，則不應使用`'tonext'`。
+        欲使用 line_polar，請將pandas版本降至 1.4.4。
         !!!note
 
             參考[plotly.graph_objects.Scatterpolar.fill](https://plotly.github.io/plotly.py-docs/generated/plotly.graph_objects.Scatterpolar.html)
 
       period (str): 選擇第幾期的特徵資料，預設為近一季。
                     ex: 設定數值為'2020-Q2，取得2020年第二季資料比較。
       cut_bins (int):特徵分級級距。
@@ -834,15 +835,18 @@
           select_strategy (dict): 選擇策略名稱並設定權重，預設是抓取權策略並平分資金比例到各策略。
                                  ex:`{'低波動本益成長比':0.5,'研發魔人':0.2, '現金':0.2}`
         Returns:
             (pd.DataFrame): strategies data
         """
         if select_strategy is None:
             s_name = self.s_data.keys()
-            s_weight = [1 / len(s_name)] * len(s_name)
+            s_num = len(s_name)
+            if s_num == 0:
+                return None
+            s_weight = [1 / s_num] * len(s_name)
         else:
             s_name = select_strategy.keys()
             s_weight = select_strategy.values()
 
         all_position = pd.concat([self.process_position(name, weight) for name, weight in zip(s_name, s_weight)])
         all_position['weight'] *= all_position['s_weight']
         all_position['return'] = round(all_position['return'].astype(float), 2)
@@ -878,14 +882,16 @@
         ex1:策略選到哪些標的?
         ![市值/本益比板塊圖](img/plot/sunburst1.png)
 
         ex2:部位被哪些策略選到，標的若被不同策略選到，可能有獨特之處喔！
         ![市值/本益比板塊圖](img/plot/sunburst2.png)
         """
         position = self.get_strategy_df(select_strategy)
+        if position is None:
+            return
         if path is None:
             path = ['s_name', 'market', 'category', 'stock_id']
         fig = px.sunburst(position, path=path, values='weight',
                           color='color', hover_data=['return'],
                           color_continuous_scale=color_continuous_scale,
                           color_continuous_midpoint=0,
                           width=1000, height=800)
```

## finlab/ml/feature.py

```diff
@@ -1,22 +1,26 @@
-from talib import abstract
-import numpy as np
 import re
-import talib
+import gc
+import copy
+import random
 import logging
-from functools import lru_cache
+import traceback
+import numpy as np
 import pandas as pd
-from finlab import data
+from functools import lru_cache
 from typing import List, Protocol, Dict, Optional, Generator
-import finlab.market_info
-from finlab.dataframe import FinlabDataFrame
-import random
-import gc
+
+import talib
+from talib import abstract
+
 from finlab import ml
+from finlab import data
+import finlab.market_info
 from finlab.ml.utils import resampler
+from finlab.dataframe import FinlabDataFrame
 
 
 class IndicatorName():
   
     @staticmethod
     def encode(package_name, func, output, params):
 
@@ -67,15 +71,17 @@
   
     def calculate_indicator(self, func, output, params, adj=False):
       
         func = func.split('.')[0]
 
         # get ith output
         f = getattr(abstract, func)
-        org_params = f.parameters
+        org_params = copy.copy(f.parameters)
+        org_params = self.set_dynamic_types(f, org_params)
+
         params = self.set_dynamic_types(f, params)
         f.set_parameters(org_params)
         target_i = -1
         for i, o in enumerate(f.output_names):
             if o == output:
                 target_i = i
                 break
@@ -137,31 +143,32 @@
           'fastperiod': 2,
           'slowperiod': 2,
           'timeperiod1': 2, 'timeperiod2': 2,
           'timeperiod3': 2,
           'fastk_period': 2, 
           'fastd_period': 2,
           'slowk_period': 2,
+          'slowd_period': 2,
           'vfactor': 0,
         }
 
         ret = []
         for _ in range(n):
 
           new_params = {}
           for k, v in org_params.items():
             rvalue = np.random.random_sample(1)[0] * (params_ub[k] - params_lb[k]) + params_lb[k]
             rvalue = type(v)(rvalue)
             new_params[k] = rvalue
             
           
           if 'nbdevup' in new_params:
-            new_params['nbdevup'] = 2
+            new_params['nbdevup'] = 2.0
           if 'nbdevdn' in new_params:
-            new_params['nbdevdn'] = 2
+            new_params['nbdevdn'] = 2.0
           if 'vfactor' in new_params:
             new_params['vfactor'] = float(random.uniform(0, 1))
           if 'nbdev' in new_params:
             new_params['nbdev'] = 2.5
             
           for p in new_params:
             if p in min_value and new_params[p] < min_value[p]:
@@ -261,18 +268,17 @@
             factory = factories[name.split('.')[0]]
             try:
                 f = resampler(factory.calculate_indicator(func, output, params).loc[start_time:end_time], resample, **kwargs).unstack()
                 yield np.array(f.values)
                 final_columns.append(name)
 
             except Exception as e:
-                logging.warn(e)
                 # traceback.print_exc(file=sys.stdout)
-                logging.warn(f"Cannot calculate indicator {name}. Skipped")
-                print(func, output, params)
+                logging.warn(f"Cannot calculate indicator {(func, output, params)}. Skipped")
+                logging.warn(f"Exception occurred: {traceback.format_exc()}")
 
     values = np.fromiter(
             create_features(), 
             dtype=np.dtype((np.float64, len(test_f))))
     ret = pd.DataFrame(values.T, index=test_f.index, 
                        columns=final_columns, copy=False).swaplevel(0,1)
     ret.index.names = ['datetime', 'instrument']
```

## finlab/ml/label.py

```diff
@@ -4,15 +4,15 @@
 
 
 def align_to_feature(index: pd.Index, df: pd.DataFrame):
     ret = df.unstack().swaplevel(0, 1).reindex(index)
     ret.index = ret.index.set_names(['datetime', 'instrument'])
     return ret
 
-def return_percentage(index: pd.Index, resample=None, period=1, **kwargs):
+def return_percentage(index: pd.Index, resample=None, period=1, trade_at_price='close', **kwargs):
 
     """Calculate the percentage change of market prices over a given period.
 
     Args:
         index (pd.Index): A multi-level index of datetime and instrument.
         resample (Optional[str]): The resample frequency for the output data. Defaults to None.
         period (int): The number of periods to calculate the percentage change over. Defaults to 1.
@@ -22,49 +22,49 @@
         pd.Series: A pd.Series containing the percentage change of stock prices.
 
     """
 
     market = ml.get_market()
     assert market is not None
 
-    adj = market.get_price('close', adj=True).shift(-1)
+    adj = market.get_price(trade_at_price, adj=True).shift(-1)
     uadj = resampler(adj, resample, **kwargs)
     ret = (uadj.shift(-period) / uadj) - 1
     return align_to_feature(index, ret)
 
 
-def maximum_adverse_excursion(index: pd.Index, period=1):
+def maximum_adverse_excursion(index: pd.Index, period=1, trade_at_price='close'):
 
     market = ml.get_market()
     assert market is not None
-    adj = market.get_price('close', adj=True).shift(-1)
+    adj = market.get_price(trade_at_price, adj=True).shift(-1)
     ret = adj.shift(-period).rolling(period).min() / adj - 1
     return align_to_feature(index, ret)
 
 
-def maximum_favorable_excursion(index: pd.Index, period=1):
+def maximum_favorable_excursion(index: pd.Index, period=1, trade_at_price='close'):
 
     market = ml.get_market()
     assert market is not None
-    adj = market.get_price('close', adj=True).shift(-1)
+    adj = market.get_price(trade_at_price, adj=True).shift(-1)
     ret = adj.shift(-period).rolling(period).max() / adj - 1
     return align_to_feature(index, ret)
 
 
-def excess_over_median(index: pd.Index, resample=None, period=1, **kwargs):
+def excess_over_median(index: pd.Index, resample=None, period=1, trade_at_price='close', **kwargs):
 
     market = ml.get_market()
-    adj = market.get_price('close', adj=True).shift(-1)
+    adj = market.get_price(trade_at_price, adj=True).shift(-1)
     uadj = resampler(adj, resample, **kwargs)
     ret = (uadj.shift(-period) / uadj) - 1
     ret -= ret.median(axis=1)
     return align_to_feature(index, ret)
 
 
-def excess_over_mean(index: pd.Index, resample=None, period=1, **kwargs):
+def excess_over_mean(index: pd.Index, resample=None, period=1, trade_at_price='close', **kwargs):
 
     market = ml.get_market()
-    adj = market.get_price('close', adj=True).shift(-1)
+    adj = market.get_price(trade_at_price, adj=True).shift(-1)
     uadj = resampler(adj, resample, **kwargs)
     ret = (uadj.shift(-period) / uadj) - 1
     ret -= ret.mean(axis=1)
     return align_to_feature(index, ret)
```

## finlab/ml/qlib.py

```diff
@@ -337,14 +337,17 @@
             'factor': ac[s].values / c[s].values,
             'symbol': s
             }).to_csv(Path(csv_path).expanduser() / f"{s}.csv")
 
     dumper = DumpDataAll(csv_path, qlib_dir, include_fields=include_fields, freq=freq)
     dumper()
 
+
+qlib_initialized = False
+
 def init():
     """Qlib 初始化 (類似於台股版 qlib.init() 但更簡單易用)
     Example:
         ```py
         import qlib
         import finlab.ml.qlib as q
 
@@ -359,40 +362,42 @@
     try:
         from qlib import config
         config._default_region_config[region] = \
                 dict(trade_unit=1000, limit_threshold=0.1, deal_price='close')
     except:
         pass
 
-    qlib.init(provider_uri=f'~/.qlib/qlib_data/{region}_data', 
-              region=region)
+    global qlib_initialized
+
+    if not qlib_initialized:
+        qlib.init(provider_uri=f'~/.qlib/qlib_data/{region}_data', 
+                  region=region)
 
 def alpha(handler='Alpha158', **kwargs):
 
     """產生 Qlib 的特徵
     Args:
         handler (str): 預設為 'alpha158' 也可以設定成 'Alpha360'
     Example:
         ```py
         import finlab.ml.qlib as q
         features = q.alpha('Alpha158')
         ```
     """
-
     init()
 
     if handler == 'Alpha158':
         h = Alpha158(instruments=D.instruments(market='all'), **kwargs)
     elif handler == 'Alpha360':
         h = Alpha360(instruments=D.instruments(market='all'), **kwargs)
     else:
         raise Exception(f"Handler {handler} not supported.")
 
     alpha = h.fetch(col_set="feature")
-    return alpha.dropna(how='all', axis=1)
+    return alpha
 
 
 class CustomDataLoader(DataLoader):
     def __init__(self, d):
         self.d = d
         
     def load(self, instruments, start_time=None, end_time=None) -> pd.DataFrame:
@@ -405,14 +410,58 @@
             selected &= t < end_time
         if instruments:
             ins = self.d.index.get_level_values('instrument')
             selected &= ins.isin(instruments) 
 
         return self.d.loc[selected]
 
+
+def make_datasetH(X, y=None, _DEFAULT_LEARN_PROCESSORS=[
+        {"class": "DropnaLabel"},
+        {"class": "CSZScoreNorm", "kwargs": {"fields_group": "label"}},
+    ]):
+
+    is_train = y is not None
+
+    if is_train:
+
+        d = pd.concat([
+            X, 
+            y.to_frame(name='LABEL0')],
+            axis=1, keys=['feature', 'label'])\
+            .sort_index()
+    
+        tmin = X.index.get_level_values('datetime').min()
+        tmax = X.index.get_level_values('datetime').max()
+
+        tsplit = (tmax - tmin) * 0.8 + tmin
+
+        segments = dict(
+            train=(tmin, tsplit),
+            valid=(tsplit + datetime.timedelta(days=1), tmax)
+        )
+        dl = CustomDataLoader(d)
+        return DatasetH(handler=DataHandlerLP(data_loader=dl, learn_processors=_DEFAULT_LEARN_PROCESSORS), segments=segments)
+
+
+    x = X.copy()
+    x.columns = pd.MultiIndex.from_tuples([('feature', x) for x in x.columns])
+
+    dl = CustomDataLoader(x)
+
+    tmin = x.index.get_level_values('datetime').min()
+    tmax = x.index.get_level_values('datetime').max()
+
+    segments = {
+        'test': (tmin, tmax)
+    }
+    
+    return DatasetH(handler=DataHandlerLP(data_loader=dl), segments=segments)
+
+
 class WrapperModel():
 
     def __init__(self, model_config, train_valid_split=0.8, purge_days=1):
         self.model = init_instance_by_config(model_config)
         self.train_valid_split = train_valid_split
         self.purge_days = purge_days
         self.params = {
@@ -422,43 +471,14 @@
                 }
 
     def get_params(self, deep=True):
         return self.params.copy()
 
     def fit(self, X_train, y_train, **fit_params):
 
-        d = pd.concat([
-            X_train, 
-            y_train.to_frame(name='LABEL0')],
-            axis=1, keys=['feature', 'label'])\
-            .dropna().sort_index()
-        
-        tmin = X_train.index.get_level_values('datetime').min()
-        tmax = X_train.index.get_level_values('datetime').max()
-
-        tsplit = (tmax - tmin) * self.train_valid_split + tmin
-
-        segments = dict(
-            train=(tmin, tsplit),
-            valid=(tsplit + datetime.timedelta(days=self.purge_days), tmax)
-        )
-
-        dl = CustomDataLoader(d)
-        dh = DatasetH(handler=DataHandlerLP(data_loader=dl), segments=segments)
+        dh = make_datasetH(X_train, y_train, fit=True)
         self.model.fit(dh, **fit_params)
 
     def predict(self, X_test):
-
-        x = X_test.copy()
-        x.columns = pd.MultiIndex.from_tuples([('feature', x) for x in x.columns])
-
-        dl = CustomDataLoader(x)
-
-        tmin = x.index.get_level_values('datetime').min()
-        tmax = x.index.get_level_values('datetime').max()
-
-        segments = {
-            'test': (tmin, tmax)
-        }
         
-        dh = DatasetH(handler=DataHandlerLP(data_loader=dl), segments=segments)
+        dh = make_datasetH(X_test, None, fit=False)
         return self.model.predict(dh)
```

## finlab/online/order_executor.py

```diff
@@ -117,15 +117,15 @@
              DeprecationWarning, stacklevel=2)
 
         ret = cls({})
         ret.position = position
         return ret
 
     @classmethod
-    def from_weight(cls, weights, fund, price=None, odd_lot=False, board_lot_size=1000, allocation=greedy_allocation):
+    def from_weight(cls, weights, fund, price=None, odd_lot=False, board_lot_size=1000, allocation=greedy_allocation, **kwargs):
         """利用 `weight` 建構股票部位
 
         Attributes:
             weights (`dict` of `float`): 股票詳細部位
             fund (number.Number): 資金大小
             price (pd.Series or `dict` of `float`): 股票代號對應到的價格，若無則使用最近個交易日的收盤價。
             odd_lot (bool): 是否考慮零股
@@ -165,15 +165,15 @@
             allocation = greedy_allocation(weights, price, fund)[0]
             for s, q in allocation.items():
                 allocation[s] = round(q) / board_lot_size
         else:
             allocation = greedy_allocation(
                 weights, price*board_lot_size, fund)[0]
 
-        return cls(allocation)
+        return cls(allocation, **kwargs)
 
     @classmethod
     def from_report(cls, report, fund, **kwargs):
         """利用回測完的報告 `finlab.report.Report` 建構股票部位。
 
         Attributes:
             report (finlab.report.Report): 回測完的結果報告。
@@ -372,21 +372,23 @@
 
             stock = stocks[o['stock_id']]
             action = Action.BUY if o['quantity'] > 0 else Action.SELL
             price = stock.close if isinstance(stock.close, numbers.Number) else (
                     stock.bid_price if action == Action.BUY else stock.ask_price
                     )
 
-            if best_price_limit or market_order:
-                limit = 'LOWEST' if action == Action.BUY else 'HIGHEST'
-                print('execute', action, o['stock_id'], 'X', abs(
-                    o['quantity']), '@', limit, o['order_condition'])
+            if best_price_limit:
+                price_string = 'LOWEST' if action == Action.BUY else 'HIGHEST'
+            elif market_order:
+                price_string = 'HIGHEST' if action == Action.BUY else 'LOWEST'
             else:
-                print('execute', action, o['stock_id'], 'X', abs(
-                    o['quantity']), '@', price, o['order_condition'])
+                price_string = str(price)
+
+            print('execute', action, o['stock_id'], 'X', abs(
+                o['quantity']), '@', price_string, o['order_condition'])
 
             quantity = abs(o['quantity'])
             board_lot_quantity = int(abs(quantity // 1))
             odd_lot_quantity = int(abs(round(1000 * (quantity % 1))))
 
             if self.account.sep_odd_lot_order():
                 if odd_lot_quantity != 0:
```

## Comparing `finlab-0.4.1.dist-info/LICENSE` & `finlab-0.4.2.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `finlab-0.4.1.dist-info/METADATA` & `finlab-0.4.2.dist-info/METADATA`

 * *Files 2% similar despite different names*

```diff
@@ -1,29 +1,31 @@
 Metadata-Version: 2.1
 Name: finlab
-Version: 0.4.1
+Version: 0.4.2
 Summary: Analyzing stock has never been easier.
 Author: FinLab
 Author-email: finlab.company@finlab.tw
+Classifier: Programming Language :: Python :: 3.6
 Classifier: Programming Language :: Python :: 3.7
 Classifier: Programming Language :: Python :: 3.8
 Classifier: Programming Language :: Python :: 3.9
 Classifier: Programming Language :: Python :: 3.10
 Classifier: License :: OSI Approved :: GNU General Public License v3 (GPLv3)
 Classifier: Operating System :: OS Independent
-Requires-Python: >=3.7
+Requires-Python: >=3.6
 Description-Content-Type: text/markdown
 License-File: LICENSE
 Requires-Dist: requests
 Requires-Dist: numpy (>=1.21.6)
 Requires-Dist: pandas (>=1.0.3)
 Requires-Dist: pyarrow (>=2.0.0)
 Requires-Dist: lz4
 Requires-Dist: Cython
 Requires-Dist: tqdm
+Requires-Dist: jinja2
 
 ---
 hide:
   - navigation
 ---
 
 # 快速上手
@@ -105,10 +107,11 @@
 
 ## 回測績效
 
 ``` py
 from finlab import backtest
 
 report = backtest.sim(position, resample='M')
+report.display()
 ```
 
 ![image](https://i.ibb.co/7kNyvhP/Screen-Shot-2021-07-13-at-11-54-29-PM.png)
```

## Comparing `finlab-0.4.1.dist-info/RECORD` & `finlab-0.4.2.dist-info/RECORD`

 * *Files 19% similar despite different names*

```diff
@@ -1,45 +1,46 @@
-finlab/__init__.py,sha256=kNyaQNbellHjU3aXhs2nkOFcGGmn65jj-EsotSvCutQ,2450
-finlab/aes.cp39-win_amd64.pyd,sha256=Q0RjkShABRtdvwNhIqiOq6rw-LWModZkj27qmTipK2Q,206848
-finlab/backtest.py,sha256=kygH80sAtWPwSeAKJmvdKa5dALcBHXeDSGZv_BD4dO4,22598
-finlab/backtest_core.cp39-win_amd64.pyd,sha256=rGtMX1wLZWUyznreHgpQcVsGWObE8VmDPdMu_HuXa1g,133632
+finlab/__init__.py,sha256=8nL_VXyUEDS1gSqeN0R19KV4DwKssZ8FftUjKHYA3Ls,2450
+finlab/aes.cp39-win_amd64.pyd,sha256=I8RcBI7Oq9jXKTnhmb49vXj2RIaDzpARQO6l4kab-P0,206848
+finlab/backtest.py,sha256=39JEASSKOwUBJsKO1pXP6y-0IsyXSwelSDZYwzCgbwI,22767
+finlab/backtest_core.cp39-win_amd64.pyd,sha256=uHMALNmV6oaz6PwC6NwN6bDZgZ8BZsEwOyi0baLuVBk,133120
 finlab/backtest_old.py,sha256=7K66Z0BkT1zsLc4F6POlLrVF7khPVhLXL69wRgE3ay8,1424
 finlab/cells.py,sha256=nRlhr8mvdViA7P8d9rHtCYe8tqbY8gVHzHsvzhY9TCo,915
 finlab/data.py,sha256=26ZM5fMR7IUNvQLcR2QwxuDRhbgvrqUBauvfFZXdIJ8,29089
-finlab/dataframe.py,sha256=Lc0UfvBof3YMk8yp4HXOIAjEV4s3BByENrwi-RX2xK4,29056
+finlab/dataframe.py,sha256=_fZCpdEcoeZ1BtI-42FMFd20QsGqpVBKRFayvU5isnQ,29113
 finlab/ffn_core.py,sha256=LTHkl6HVzkhUlMPqNGqEkN92ux7Q7VOXlljWIM41N0o,80750
-finlab/mae_mfe.cp39-win_amd64.pyd,sha256=V89rnHbVyuGzwLoKckJLXpZVx_bFnh4lX-gfm5tAkzY,73216
+finlab/mae_mfe.cp39-win_amd64.pyd,sha256=ZABM6ssJqq7rlOIQpqzadplsmg0GPtT0SY-Tfv5-oxc,71680
 finlab/mae_mfe.pxd,sha256=Lmf_StbLnzvQhIxqae_V47MOFgp_IsylFmgmVdnwIFg,460
-finlab/market_info.py,sha256=iDoKgbcZ2EHvv0pJmuv1s-3w14UrCcJjeA3sm67FNTw,3757
-finlab/plot.py,sha256=MMwN-XHULVYb7AF0ntaunujRwEZM3il_1cySMZ3lN1A,36059
-finlab/report.cp39-win_amd64.pyd,sha256=VGNJAxKjx0Roio9GltaOecEGu7IQ3eA9OUGq_3hckI0,166912
+finlab/market_info.py,sha256=2IXny2DfSm8A8iLemZxZuKyv8nlNXiy-OG7wX-J9hWs,5105
+finlab/plot.py,sha256=HJtYLY0dhjxQnSTlP4CCsnvvbzb64VyTKMsK-Mr8je8,36257
+finlab/report.cp39-win_amd64.pyd,sha256=LGF_1XlCFz-p95N0SsCDroK1y7c_ac0xoIn0dGTje2Y,167424
 finlab/utils.py,sha256=QVttpM6h85PggRsRIMXs44kMz9ktsyoKgbnKkRPm1Jg,5132
-finlab/utils_core.cp39-win_amd64.pyd,sha256=cSQ01mN7phAeRxsRXgvcmdVoY8h__WnZE3wo4w7U-VU,19968
+finlab/utils_core.cp39-win_amd64.pyd,sha256=9KAhisMJ3b34M-knJs-wmR4ube5ooxdr8dWBU4VmdH0,19968
 finlab/analysis/__init__.py,sha256=YboGTgUSD6RRHD4p58FT3hB_DerT6T_vNlWXlNCJbsg,7287
 finlab/analysis/alphaBetaAnalysis.py,sha256=6ixBH9JT4ERx_i5qTuumr3-WgJhp4upsJEZgbzGe2Nc,1988
 finlab/analysis/drawdownAnalysis.py,sha256=B9lhGVwBkwbJCfg8ac0xVk9EoaErB1x0prmz9q7_A7s,1449
 finlab/analysis/inequalityAnalysis.py,sha256=PuE11Eloz22SSBlLURmzO9CBAx5fnEX1_qa5IKUp70Q,5007
 finlab/analysis/liquidityAnalysis.py,sha256=YlpYg52TWZ6d_gmCTAGjcaaHtZ3iwsoKdUpptrs_QBw,4626
 finlab/analysis/maeMfeAnalysis.py,sha256=sWPvaRRLmZN1FU7qWjedpI0PhXdZVhhC7UUJyg-71Is,12343
 finlab/analysis/periodStatsAnalysis.py,sha256=ECB91mTNvM3sjB_WfwGU_8W3iadQYGcfL-vVE2a0Pss,3618
 finlab/ml/__init__.py,sha256=oV4GCvyk_mXbfhR0cH5CzDn970EVlYhS8sSUh0KIkpY,704
-finlab/ml/feature.py,sha256=mw1SuL85CksPb8Sbs-Uw0noPg-TvEkM7iGQ95xouMIM,15448
-finlab/ml/label.py,sha256=1s9_ir8KmGJKqiXut3kMIaa5JzbGWTt3adlGXdRC5cU,2404
-finlab/ml/qlib.py,sha256=GjQHtUTc_wO7nUOtffw6Bi5WxMelNuV1DiWKxIdi0sM,17707
+finlab/ml/alphalens.py,sha256=omMSqjVwSgY8_izLM8umrf_t2cwGwBr8Nxwntnj-ZVY,3879
+finlab/ml/feature.py,sha256=moHX-OJFzY5FHCSPXm4CXIXIaM7tgEcHaymXWHYvU0o,15609
+finlab/ml/label.py,sha256=Ayn8xf-0zbyQYndnUv0cLNxE3B3Vs_8TbAmplSgrp1I,2559
+finlab/ml/qlib.py,sha256=c-yFL6VR6GL7rpLhuTp9XyJoZxcQRlFNB7Ew0UzFbns,18065
 finlab/ml/utils.py,sha256=UiKIfL69zREH9GrOP_MRQxUA162D9PzHRqXSEj64odI,3131
 finlab/online/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 finlab/online/base_account.py,sha256=PiIQjIgjTf6fcYtlbWevwZ_T40qvwpBjesdecvWd1ok,8155
 finlab/online/binance_account.py,sha256=bxTsx1sI1BDnx1OKWAxTvWm96-BGsWCrxQNOHszJ1Xg,12766
 finlab/online/dashboard.py,sha256=hhLoQDgytda4xW_wOLb3rlOO_j_W5aILlwjNrKwX2QI,7264
 finlab/online/enums.py,sha256=7X5VmoaffdVDFNiRF-EIeRBtroGmLGEryVlxLmurWro,263
 finlab/online/fugle_account.py,sha256=Dvk6TA6FLWFXDWnY3034kG1n8BLu0dcepo-jUw0RJNA,12844
-finlab/online/order_executor.py,sha256=KcbPv1b79c5hLsg36yvVI5BjP9hrQ1DZC62QZ4drfhs,17102
+finlab/online/order_executor.py,sha256=D4n_4SqtzySZEaC21OC0T4FBK0oQRYpncUxYsA8aCIM,17131
 finlab/online/panel.py,sha256=pL7vHsZfmNYI0LqZN-2amZgPXyViznUqNCzQTZVz170,13122
 finlab/online/sinopac_account.py,sha256=fp4DaWFaHof93yqhDuZXwBeFP2KRFVjQOdk0VtriH-M,8537
 finlab/online/utils.py,sha256=CiLEnPvB5e94eNKaOISe0b1-YG_JHhJF5LYpRyWoN_o,5432
 finlab/optimize/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 finlab/optimize/combinations.py,sha256=3KSMgffs6QJUcLBg_0gMbdrjxBKoix9gU9xlsmLmud4,8815
-finlab-0.4.1.dist-info/LICENSE,sha256=IwGE9guuL-ryRPEKi6wFPI_zOhg7zDZbTYuHbSt_SAk,35823
-finlab-0.4.1.dist-info/METADATA,sha256=p7x_RzyKXEzfiYr3lxoXe_7-08upc0g3sYhOk2tMCDo,3787
-finlab-0.4.1.dist-info/WHEEL,sha256=eep6QWEFiQfg2wcclssb_WY-D33AnLYLnEKGA9Rn-VU,100
-finlab-0.4.1.dist-info/top_level.txt,sha256=m5gMT8MS1RxoL-WPzxP83LozK_ubRB3AN7d9shpXNIQ,7
-finlab-0.4.1.dist-info/RECORD,,
+finlab-0.4.2.dist-info/LICENSE,sha256=IwGE9guuL-ryRPEKi6wFPI_zOhg7zDZbTYuHbSt_SAk,35823
+finlab-0.4.2.dist-info/METADATA,sha256=pNCjmTyGpJvBM-M2K4QZecXvoh_zJsxZXgY0xZuLJkE,3879
+finlab-0.4.2.dist-info/WHEEL,sha256=eep6QWEFiQfg2wcclssb_WY-D33AnLYLnEKGA9Rn-VU,100
+finlab-0.4.2.dist-info/top_level.txt,sha256=m5gMT8MS1RxoL-WPzxP83LozK_ubRB3AN7d9shpXNIQ,7
+finlab-0.4.2.dist-info/RECORD,,
```

