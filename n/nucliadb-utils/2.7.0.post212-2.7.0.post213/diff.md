# Comparing `tmp/nucliadb_utils-2.7.0.post212-py3-none-any.whl.zip` & `tmp/nucliadb_utils-2.7.0.post213-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,69 +1,69 @@
-Zip file size: 96219 bytes, number of entries: 67
--rw-r--r--  2.0 unx      895 b- defN 23-Apr-26 13:06 nucliadb_utils/__init__.py
--rw-r--r--  2.0 unx     5877 b- defN 23-Apr-26 13:06 nucliadb_utils/authentication.py
--rw-r--r--  2.0 unx     4518 b- defN 23-Apr-26 13:06 nucliadb_utils/clandestined.py
--rw-r--r--  2.0 unx     1090 b- defN 23-Apr-26 13:06 nucliadb_utils/exceptions.py
--rw-r--r--  2.0 unx     1979 b- defN 23-Apr-26 13:06 nucliadb_utils/featureflagging.py
--rw-r--r--  2.0 unx     2212 b- defN 23-Apr-26 13:06 nucliadb_utils/grpc.py
--rw-r--r--  2.0 unx     3572 b- defN 23-Apr-26 13:06 nucliadb_utils/indexing.py
--rw-r--r--  2.0 unx      867 b- defN 23-Apr-26 13:06 nucliadb_utils/keys.py
--rw-r--r--  2.0 unx     1519 b- defN 23-Apr-26 13:06 nucliadb_utils/nats.py
--rw-r--r--  2.0 unx     1173 b- defN 23-Apr-26 13:06 nucliadb_utils/partition.py
--rw-r--r--  2.0 unx        0 b- defN 23-Apr-26 13:06 nucliadb_utils/py.typed
--rw-r--r--  2.0 unx     1713 b- defN 23-Apr-26 13:06 nucliadb_utils/run.py
--rw-r--r--  2.0 unx     4649 b- defN 23-Apr-26 13:06 nucliadb_utils/settings.py
--rw-r--r--  2.0 unx      890 b- defN 23-Apr-26 13:06 nucliadb_utils/store.py
--rw-r--r--  2.0 unx     6633 b- defN 23-Apr-26 13:06 nucliadb_utils/transaction.py
--rw-r--r--  2.0 unx    10979 b- defN 23-Apr-26 13:06 nucliadb_utils/utilities.py
--rw-r--r--  2.0 unx      835 b- defN 23-Apr-26 13:06 nucliadb_utils/audit/__init__.py
--rw-r--r--  2.0 unx     2013 b- defN 23-Apr-26 13:06 nucliadb_utils/audit/audit.py
--rw-r--r--  2.0 unx     2446 b- defN 23-Apr-26 13:06 nucliadb_utils/audit/basic.py
--rw-r--r--  2.0 unx     7688 b- defN 23-Apr-26 13:06 nucliadb_utils/audit/stream.py
--rw-r--r--  2.0 unx      900 b- defN 23-Apr-26 13:06 nucliadb_utils/cache/__init__.py
--rw-r--r--  2.0 unx      975 b- defN 23-Apr-26 13:06 nucliadb_utils/cache/exceptions.py
--rw-r--r--  2.0 unx     1216 b- defN 23-Apr-26 13:06 nucliadb_utils/cache/memcache.py
--rw-r--r--  2.0 unx     6776 b- defN 23-Apr-26 13:06 nucliadb_utils/cache/nats.py
--rw-r--r--  2.0 unx     1654 b- defN 23-Apr-26 13:06 nucliadb_utils/cache/pubsub.py
--rw-r--r--  2.0 unx     3110 b- defN 23-Apr-26 13:06 nucliadb_utils/cache/redis.py
--rw-r--r--  2.0 unx     1302 b- defN 23-Apr-26 13:06 nucliadb_utils/cache/settings.py
--rw-r--r--  2.0 unx     5906 b- defN 23-Apr-26 13:06 nucliadb_utils/cache/utility.py
--rw-r--r--  2.0 unx      833 b- defN 23-Apr-26 13:06 nucliadb_utils/fastapi/__init__.py
--rw-r--r--  2.0 unx     1737 b- defN 23-Apr-26 13:06 nucliadb_utils/fastapi/openapi.py
--rw-r--r--  2.0 unx     3875 b- defN 23-Apr-26 13:06 nucliadb_utils/fastapi/run.py
--rw-r--r--  2.0 unx     3786 b- defN 23-Apr-26 13:06 nucliadb_utils/fastapi/versioning.py
--rw-r--r--  2.0 unx      855 b- defN 23-Apr-26 13:06 nucliadb_utils/storages/__init__.py
--rw-r--r--  2.0 unx     2274 b- defN 23-Apr-26 13:06 nucliadb_utils/storages/exceptions.py
--rw-r--r--  2.0 unx    24880 b- defN 23-Apr-26 13:06 nucliadb_utils/storages/gcs.py
--rw-r--r--  2.0 unx    10180 b- defN 23-Apr-26 13:06 nucliadb_utils/storages/local.py
--rw-r--r--  2.0 unx     2093 b- defN 23-Apr-26 13:06 nucliadb_utils/storages/nuclia.py
--rw-r--r--  2.0 unx    17174 b- defN 23-Apr-26 13:06 nucliadb_utils/storages/pg.py
--rw-r--r--  2.0 unx    15029 b- defN 23-Apr-26 13:06 nucliadb_utils/storages/s3.py
--rw-r--r--  2.0 unx     1276 b- defN 23-Apr-26 13:06 nucliadb_utils/storages/settings.py
--rw-r--r--  2.0 unx    17637 b- defN 23-Apr-26 13:06 nucliadb_utils/storages/storage.py
--rw-r--r--  2.0 unx      833 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/__init__.py
--rw-r--r--  2.0 unx    10691 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/asyncbenchmark.py
--rw-r--r--  2.0 unx     1043 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/clandestined.py
--rw-r--r--  2.0 unx     1686 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/conftest.py
--rw-r--r--  2.0 unx     2758 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/gcs.py
--rw-r--r--  2.0 unx     2307 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/indexing.py
--rw-r--r--  2.0 unx     1310 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/local.py
--rw-r--r--  2.0 unx     7697 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/nats.py
--rw-r--r--  2.0 unx     2216 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/s3.py
--rw-r--r--  2.0 unx      833 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/unit/__init__.py
--rw-r--r--  2.0 unx     5159 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/unit/test_authentication.py
--rw-r--r--  2.0 unx    14507 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/unit/test_clandestined.py
--rw-r--r--  2.0 unx     1949 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/unit/test_clandestined_collision.py
--rw-r--r--  2.0 unx     5303 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/unit/test_clandestined_rendezvous_hash.py
--rw-r--r--  2.0 unx     1910 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/unit/test_run.py
--rw-r--r--  2.0 unx     1189 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/unit/test_tests.py
--rw-r--r--  2.0 unx     1667 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/unit/test_transaction.py
--rw-r--r--  2.0 unx     5216 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/unit/test_utilities.py
--rw-r--r--  2.0 unx      833 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/unit/storages/__init__.py
--rw-r--r--  2.0 unx    16726 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/unit/storages/test_pg.py
--rw-r--r--  2.0 unx     5638 b- defN 23-Apr-26 13:06 nucliadb_utils/tests/unit/storages/test_storage.py
--rw-r--r--  2.0 unx     1776 b- defN 23-Apr-26 13:08 nucliadb_utils-2.7.0.post212.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Apr-26 13:08 nucliadb_utils-2.7.0.post212.dist-info/WHEEL
--rw-r--r--  2.0 unx       15 b- defN 23-Apr-26 13:08 nucliadb_utils-2.7.0.post212.dist-info/top_level.txt
--rw-r--r--  2.0 unx        1 b- defN 23-Apr-26 13:07 nucliadb_utils-2.7.0.post212.dist-info/zip-safe
--rw-rw-r--  2.0 unx     6033 b- defN 23-Apr-26 13:08 nucliadb_utils-2.7.0.post212.dist-info/RECORD
-67 files, 284404 bytes uncompressed, 86545 bytes compressed:  69.6%
+Zip file size: 96515 bytes, number of entries: 67
+-rw-r--r--  2.0 unx      895 b- defN 23-Apr-26 19:10 nucliadb_utils/__init__.py
+-rw-r--r--  2.0 unx     5877 b- defN 23-Apr-26 19:10 nucliadb_utils/authentication.py
+-rw-r--r--  2.0 unx     4518 b- defN 23-Apr-26 19:10 nucliadb_utils/clandestined.py
+-rw-r--r--  2.0 unx     1138 b- defN 23-Apr-26 19:10 nucliadb_utils/exceptions.py
+-rw-r--r--  2.0 unx     1979 b- defN 23-Apr-26 19:10 nucliadb_utils/featureflagging.py
+-rw-r--r--  2.0 unx     2212 b- defN 23-Apr-26 19:10 nucliadb_utils/grpc.py
+-rw-r--r--  2.0 unx     3572 b- defN 23-Apr-26 19:10 nucliadb_utils/indexing.py
+-rw-r--r--  2.0 unx      867 b- defN 23-Apr-26 19:10 nucliadb_utils/keys.py
+-rw-r--r--  2.0 unx     1519 b- defN 23-Apr-26 19:10 nucliadb_utils/nats.py
+-rw-r--r--  2.0 unx     1173 b- defN 23-Apr-26 19:10 nucliadb_utils/partition.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Apr-26 19:10 nucliadb_utils/py.typed
+-rw-r--r--  2.0 unx     1713 b- defN 23-Apr-26 19:10 nucliadb_utils/run.py
+-rw-r--r--  2.0 unx     5048 b- defN 23-Apr-26 19:10 nucliadb_utils/settings.py
+-rw-r--r--  2.0 unx      890 b- defN 23-Apr-26 19:10 nucliadb_utils/store.py
+-rw-r--r--  2.0 unx     6633 b- defN 23-Apr-26 19:10 nucliadb_utils/transaction.py
+-rw-r--r--  2.0 unx    11309 b- defN 23-Apr-26 19:10 nucliadb_utils/utilities.py
+-rw-r--r--  2.0 unx      835 b- defN 23-Apr-26 19:10 nucliadb_utils/audit/__init__.py
+-rw-r--r--  2.0 unx     2013 b- defN 23-Apr-26 19:10 nucliadb_utils/audit/audit.py
+-rw-r--r--  2.0 unx     2446 b- defN 23-Apr-26 19:10 nucliadb_utils/audit/basic.py
+-rw-r--r--  2.0 unx     7688 b- defN 23-Apr-26 19:10 nucliadb_utils/audit/stream.py
+-rw-r--r--  2.0 unx      900 b- defN 23-Apr-26 19:10 nucliadb_utils/cache/__init__.py
+-rw-r--r--  2.0 unx      975 b- defN 23-Apr-26 19:10 nucliadb_utils/cache/exceptions.py
+-rw-r--r--  2.0 unx     1216 b- defN 23-Apr-26 19:10 nucliadb_utils/cache/memcache.py
+-rw-r--r--  2.0 unx     6776 b- defN 23-Apr-26 19:10 nucliadb_utils/cache/nats.py
+-rw-r--r--  2.0 unx     1654 b- defN 23-Apr-26 19:10 nucliadb_utils/cache/pubsub.py
+-rw-r--r--  2.0 unx     3110 b- defN 23-Apr-26 19:10 nucliadb_utils/cache/redis.py
+-rw-r--r--  2.0 unx     1302 b- defN 23-Apr-26 19:10 nucliadb_utils/cache/settings.py
+-rw-r--r--  2.0 unx     5906 b- defN 23-Apr-26 19:10 nucliadb_utils/cache/utility.py
+-rw-r--r--  2.0 unx      833 b- defN 23-Apr-26 19:10 nucliadb_utils/fastapi/__init__.py
+-rw-r--r--  2.0 unx     1737 b- defN 23-Apr-26 19:10 nucliadb_utils/fastapi/openapi.py
+-rw-r--r--  2.0 unx     3875 b- defN 23-Apr-26 19:10 nucliadb_utils/fastapi/run.py
+-rw-r--r--  2.0 unx     3786 b- defN 23-Apr-26 19:10 nucliadb_utils/fastapi/versioning.py
+-rw-r--r--  2.0 unx      855 b- defN 23-Apr-26 19:10 nucliadb_utils/storages/__init__.py
+-rw-r--r--  2.0 unx     2274 b- defN 23-Apr-26 19:10 nucliadb_utils/storages/exceptions.py
+-rw-r--r--  2.0 unx    24880 b- defN 23-Apr-26 19:10 nucliadb_utils/storages/gcs.py
+-rw-r--r--  2.0 unx    10180 b- defN 23-Apr-26 19:10 nucliadb_utils/storages/local.py
+-rw-r--r--  2.0 unx     2093 b- defN 23-Apr-26 19:10 nucliadb_utils/storages/nuclia.py
+-rw-r--r--  2.0 unx    17174 b- defN 23-Apr-26 19:10 nucliadb_utils/storages/pg.py
+-rw-r--r--  2.0 unx    15029 b- defN 23-Apr-26 19:10 nucliadb_utils/storages/s3.py
+-rw-r--r--  2.0 unx     1276 b- defN 23-Apr-26 19:10 nucliadb_utils/storages/settings.py
+-rw-r--r--  2.0 unx    17637 b- defN 23-Apr-26 19:10 nucliadb_utils/storages/storage.py
+-rw-r--r--  2.0 unx      833 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/__init__.py
+-rw-r--r--  2.0 unx    10691 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/asyncbenchmark.py
+-rw-r--r--  2.0 unx     1043 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/clandestined.py
+-rw-r--r--  2.0 unx     1686 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/conftest.py
+-rw-r--r--  2.0 unx     2758 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/gcs.py
+-rw-r--r--  2.0 unx     2307 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/indexing.py
+-rw-r--r--  2.0 unx     1310 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/local.py
+-rw-r--r--  2.0 unx     7697 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/nats.py
+-rw-r--r--  2.0 unx     2216 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/s3.py
+-rw-r--r--  2.0 unx      833 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/unit/__init__.py
+-rw-r--r--  2.0 unx     5159 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/unit/test_authentication.py
+-rw-r--r--  2.0 unx    14507 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/unit/test_clandestined.py
+-rw-r--r--  2.0 unx     1949 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/unit/test_clandestined_collision.py
+-rw-r--r--  2.0 unx     5303 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/unit/test_clandestined_rendezvous_hash.py
+-rw-r--r--  2.0 unx     1910 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/unit/test_run.py
+-rw-r--r--  2.0 unx     1189 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/unit/test_tests.py
+-rw-r--r--  2.0 unx     1667 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/unit/test_transaction.py
+-rw-r--r--  2.0 unx     5277 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/unit/test_utilities.py
+-rw-r--r--  2.0 unx      833 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/unit/storages/__init__.py
+-rw-r--r--  2.0 unx    16726 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/unit/storages/test_pg.py
+-rw-r--r--  2.0 unx     5638 b- defN 23-Apr-26 19:10 nucliadb_utils/tests/unit/storages/test_storage.py
+-rw-r--r--  2.0 unx     1776 b- defN 23-Apr-26 19:11 nucliadb_utils-2.7.0.post213.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Apr-26 19:11 nucliadb_utils-2.7.0.post213.dist-info/WHEEL
+-rw-r--r--  2.0 unx       15 b- defN 23-Apr-26 19:11 nucliadb_utils-2.7.0.post213.dist-info/top_level.txt
+-rw-r--r--  2.0 unx        1 b- defN 23-Apr-26 19:10 nucliadb_utils-2.7.0.post213.dist-info/zip-safe
+-rw-rw-r--  2.0 unx     6033 b- defN 23-Apr-26 19:11 nucliadb_utils-2.7.0.post213.dist-info/RECORD
+67 files, 285242 bytes uncompressed, 86841 bytes compressed:  69.6%
```

## zipnote {}

```diff
@@ -180,23 +180,23 @@
 
 Filename: nucliadb_utils/tests/unit/storages/test_pg.py
 Comment: 
 
 Filename: nucliadb_utils/tests/unit/storages/test_storage.py
 Comment: 
 
-Filename: nucliadb_utils-2.7.0.post212.dist-info/METADATA
+Filename: nucliadb_utils-2.7.0.post213.dist-info/METADATA
 Comment: 
 
-Filename: nucliadb_utils-2.7.0.post212.dist-info/WHEEL
+Filename: nucliadb_utils-2.7.0.post213.dist-info/WHEEL
 Comment: 
 
-Filename: nucliadb_utils-2.7.0.post212.dist-info/top_level.txt
+Filename: nucliadb_utils-2.7.0.post213.dist-info/top_level.txt
 Comment: 
 
-Filename: nucliadb_utils-2.7.0.post212.dist-info/zip-safe
+Filename: nucliadb_utils-2.7.0.post213.dist-info/zip-safe
 Comment: 
 
-Filename: nucliadb_utils-2.7.0.post212.dist-info/RECORD
+Filename: nucliadb_utils-2.7.0.post213.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## nucliadb_utils/exceptions.py

```diff
@@ -27,7 +27,11 @@
     def __init__(self, status_code: int, detail: str):
         self.status_code = status_code
         self.detail = detail
 
 
 class ShardsNotFound(Exception):
     pass
+
+
+class ConfigurationError(Exception):
+    pass
```

## nucliadb_utils/settings.py

```diff
@@ -13,14 +13,15 @@
 # but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 # GNU Affero General Public License for more details.
 #
 # You should have received a copy of the GNU Affero General Public License
 # along with this program. If not, see <http://www.gnu.org/licenses/>.
 
+from enum import Enum
 from typing import Dict, List, Optional
 
 from pydantic import BaseSettings, Field
 from pydantic.class_validators import root_validator
 
 
 class RunningSettings(BaseSettings):
@@ -45,16 +46,33 @@
 class HTTPSettings(BaseSettings):
     cors_origins: List[str] = ["http://localhost:4200"]
 
 
 http_settings = HTTPSettings()
 
 
+class FileBackendConfig(str, Enum):
+    GCS = "gcs"
+    S3 = "s3"
+    PG = "pg"
+    LOCAL = "local"
+    NOT_SET = "notset"  # setting not provided
+
+    @classmethod
+    def _missing_(cls, value):
+        """
+        allow case insensitive enum values
+        """
+        for member in cls:
+            if member.value == value.lower():
+                return member
+
+
 class StorageSettings(BaseSettings):
-    file_backend: str = "gcs"  # gcs | s3 | pg | local
+    file_backend: FileBackendConfig = FileBackendConfig.NOT_SET
 
     gcs_base64_creds: Optional[str] = None
     gcs_bucket: Optional[str] = None
     gcs_location: Optional[str] = None
     gcs_project: Optional[str] = None
     gcs_bucket_labels: Dict[str, str] = {}
     gcs_endpoint_url: str = "https://www.googleapis.com"
```

## nucliadb_utils/utilities.py

```diff
@@ -32,17 +32,23 @@
 from nucliadb_utils.audit.basic import BasicAuditStorage
 from nucliadb_utils.audit.stream import StreamAuditStorage
 from nucliadb_utils.cache.nats import NatsPubsub
 from nucliadb_utils.cache.pubsub import PubSubDriver
 from nucliadb_utils.cache.redis import RedisPubsub
 from nucliadb_utils.cache.settings import settings as cache_settings
 from nucliadb_utils.cache.utility import Cache
+from nucliadb_utils.exceptions import ConfigurationError
 from nucliadb_utils.indexing import IndexingUtility
 from nucliadb_utils.partition import PartitionUtility
-from nucliadb_utils.settings import audit_settings, nuclia_settings, storage_settings
+from nucliadb_utils.settings import (
+    FileBackendConfig,
+    audit_settings,
+    nuclia_settings,
+    storage_settings,
+)
 from nucliadb_utils.storages.settings import settings as extended_storage_settings
 from nucliadb_utils.store import MAIN
 from nucliadb_utils.transaction import TransactionUtility
 
 if TYPE_CHECKING:  # pragma: no cover
     from nucliadb_utils.storages.local import LocalStorage
     from nucliadb_utils.storages.nuclia import NucliaStorage
@@ -81,15 +87,18 @@
     if ident in MAIN:
         del MAIN[ident]
 
 
 async def get_storage(
     gcs_scopes: Optional[List[str]] = None, service_name: Optional[str] = None
 ) -> Storage:
-    if storage_settings.file_backend == "s3" and Utility.STORAGE not in MAIN:
+    if Utility.STORAGE in MAIN:
+        return MAIN[Utility.STORAGE]
+
+    if storage_settings.file_backend == FileBackendConfig.S3:
         from nucliadb_utils.storages.s3 import S3Storage
 
         s3util = S3Storage(
             aws_client_id=storage_settings.s3_client_id,
             aws_client_secret=storage_settings.s3_client_secret,
             endpoint_url=storage_settings.s3_endpoint,
             verify_ssl=storage_settings.s3_verify_ssl,
@@ -100,15 +109,15 @@
             max_pool_connections=storage_settings.s3_max_pool_connections,
             bucket=storage_settings.s3_bucket,
         )
         set_utility(Utility.STORAGE, s3util)
         await s3util.initialize()
         logger.info("Configuring S3 Storage")
 
-    elif storage_settings.file_backend == "gcs" and Utility.STORAGE not in MAIN:
+    elif storage_settings.file_backend == FileBackendConfig.GCS:
         from nucliadb_utils.storages.gcs import GCSStorage
 
         gcsutil = GCSStorage(
             url=storage_settings.gcs_endpoint_url,
             account_credentials=storage_settings.gcs_base64_creds,
             bucket=storage_settings.gcs_bucket,
             location=storage_settings.gcs_location,
@@ -119,38 +128,37 @@
             labels=storage_settings.gcs_bucket_labels,
             scopes=gcs_scopes,
         )
         set_utility(Utility.STORAGE, gcsutil)
         await gcsutil.initialize(service_name)
         logger.info("Configuring GCS Storage")
 
-    elif storage_settings.file_backend == "pg" and Utility.STORAGE not in MAIN:
+    elif storage_settings.file_backend == FileBackendConfig.PG:
         from nucliadb_utils.storages.pg import PostgresStorage
 
         pgutil = PostgresStorage(storage_settings.driver_pg_url)  # type: ignore
         set_utility(Utility.STORAGE, pgutil)
         await pgutil.initialize()
-        logger.info("Configuring GCS Storage")
+        logger.info("Configuring Postgres Storage")
 
-    elif (
-        storage_settings.file_backend == "local"
-        and Utility.STORAGE not in MAIN
-        and storage_settings.local_files
-    ):
+    elif storage_settings.file_backend == FileBackendConfig.LOCAL:
+        if storage_settings.local_files is None:
+            raise ConfigurationError("LOCAL_FILES env var not configured")
         from nucliadb_utils.storages.local import LocalStorage
 
         localutil = LocalStorage(
             local_testing_files=storage_settings.local_files,
         )
         set_utility(Utility.STORAGE, localutil)
         await localutil.initialize()
         logger.info("Configuring Local Storage")
-
-    if MAIN.get(Utility.STORAGE) is None:
-        raise AttributeError()
+    else:
+        raise ConfigurationError(
+            "Invalid storage settings, please configure FILE_BACKEND"
+        )
 
     return MAIN[Utility.STORAGE]
 
 
 def get_local_storage() -> LocalStorage:
     if "local_storage" not in MAIN:
         from nucliadb_utils.storages.local import LocalStorage
@@ -243,15 +251,18 @@
 
 
 def get_audit() -> Optional[AuditStorage]:
     return get_utility(Utility.AUDIT)
 
 
 async def start_audit_utility(service: str):
-    audit_utility: Optional[AuditStorage] = None
+    audit_utility: Optional[AuditStorage] = get_utility(Utility.AUDIT)
+    if audit_utility is not None:
+        return
+
     if audit_settings.audit_driver == "basic":
         audit_utility = BasicAuditStorage()
         logger.info("Configuring basic audit log")
     elif audit_settings.audit_driver == "stream":
         audit_utility = StreamAuditStorage(
             nats_creds=audit_settings.audit_jetstream_auth,
             nats_servers=audit_settings.audit_jetstream_servers,
@@ -259,16 +270,17 @@
             partitions=audit_settings.audit_partitions,
             seed=audit_settings.audit_hash_seed,
             service=service,
         )
         logger.info(
             f"Configuring stream audit log {audit_settings.audit_jetstream_target}"
         )
-    if audit_utility:
-        await audit_utility.initialize()
+    else:
+        raise ConfigurationError("Invalid audit driver")
+    await audit_utility.initialize()
     set_utility(Utility.AUDIT, audit_utility)
 
 
 async def stop_audit_utility():
     audit_utility = get_audit()
     if audit_utility:
         await audit_utility.finalize()
```

## nucliadb_utils/tests/unit/test_utilities.py

```diff
@@ -19,14 +19,15 @@
 
 import hashlib
 from unittest.mock import AsyncMock, MagicMock, patch
 
 import pytest
 
 from nucliadb_utils import featureflagging, utilities
+from nucliadb_utils.exceptions import ConfigurationError
 
 
 @pytest.fixture(autouse=True)
 def reset_main():
     utilities.MAIN.clear()
 
 
@@ -74,15 +75,15 @@
     ):
         assert await utilities.get_storage() == local
 
 
 @pytest.mark.asyncio
 async def test_get_storage_missing():
     with patch.object(utilities.storage_settings, "file_backend", "missing"):
-        with pytest.raises(AttributeError):
+        with pytest.raises(ConfigurationError):
             await utilities.get_storage()
 
 
 @pytest.mark.asyncio
 async def test_get_local_storage():
     assert utilities.get_local_storage() is not None
```

## Comparing `nucliadb_utils-2.7.0.post212.dist-info/METADATA` & `nucliadb_utils-2.7.0.post213.dist-info/METADATA`

 * *Files 10% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: nucliadb-utils
-Version: 2.7.0.post212
+Version: 2.7.0.post213
 Summary: UNKNOWN
 Home-page: https://nuclia.com
 License: BSD
 Platform: UNKNOWN
 Classifier: Development Status :: 4 - Beta
 Classifier: Programming Language :: Python :: 3.7
 Classifier: Topic :: Software Development :: Libraries :: Python Modules
@@ -12,15 +12,15 @@
 Requires-Dist: aiohttp (>=3.8.1)
 Requires-Dist: prometheus-client (>=0.12.0)
 Requires-Dist: types-requests (>=2.27.7)
 Requires-Dist: mmh3 (>=3.0.0)
 Requires-Dist: nats-py[nkeys] (==2.1.3)
 Requires-Dist: pyjwt (>=2.4.0)
 Requires-Dist: memorylru (>=1.1.2)
-Requires-Dist: nucliadb-protos (==2.7.0-post212)
+Requires-Dist: nucliadb-protos (==2.7.0-post213)
 Requires-Dist: nucliadb-telemetry (>=1.9.2)
 Requires-Dist: mrflagly
 Provides-Extra: cache
 Requires-Dist: redis (>=4.3.4) ; extra == 'cache'
 Requires-Dist: orjson (>=3.6.7) ; extra == 'cache'
 Requires-Dist: lru-dict (>=1.1.7) ; extra == 'cache'
 Provides-Extra: fastapi
```

## Comparing `nucliadb_utils-2.7.0.post212.dist-info/RECORD` & `nucliadb_utils-2.7.0.post213.dist-info/RECORD`

 * *Files 2% similar despite different names*

```diff
@@ -1,23 +1,23 @@
 nucliadb_utils/__init__.py,sha256=EvBCH1iTODe-AgXm48aj4kVUt_Std3PeL8QnwimR5wI,895
 nucliadb_utils/authentication.py,sha256=Ww3aTu1SrU0KvHZDSr14Ys_iplQXgAgA_GsdRDp51lY,5877
 nucliadb_utils/clandestined.py,sha256=impMwO7eLA-peRuY4nPqMtMLHWU1nZQC040SHC22XJg,4518
-nucliadb_utils/exceptions.py,sha256=qLsVXniEfWaLxGNhEQc06e6FR2k8lILjPa8Bp8inZz4,1090
+nucliadb_utils/exceptions.py,sha256=o6UkFIq1jV1p7n3j73L4MyrGs9j3SJ2Fa-1hOH1KGhY,1138
 nucliadb_utils/featureflagging.py,sha256=et-tqdLviyr-nk_X60jlhhLVWOimuy0JLCfdjsA3uJw,1979
 nucliadb_utils/grpc.py,sha256=DJE9tQDvjUiiyF43F3Bsl5tfXmjO49l89IETfBOgCIo,2212
 nucliadb_utils/indexing.py,sha256=JSyNSzAbYthomDI2hvr9KaH9nGE7IURPZA0wAUNnzSc,3572
 nucliadb_utils/keys.py,sha256=fjumJHFoRaTbasLO5jZJ46xacAy-HqYAN-8Oquup75o,867
 nucliadb_utils/nats.py,sha256=YW4uMrgL0Ih3SMd5Yo_kHZtas86WXrKo-Nb7HQjEPR4,1519
 nucliadb_utils/partition.py,sha256=0tmXuwRM_v-OmKoRkB--OMDzomVEkmgxqMmNNomI_24,1173
 nucliadb_utils/py.typed,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 nucliadb_utils/run.py,sha256=bKMfsPEK6WdWfiPyWPUxCqcLo4tq6eOwyaf910TOwBk,1713
-nucliadb_utils/settings.py,sha256=23v5-fKtxXxrqJiC2JRIRRMLLBMrvjg3RhOnQ-xJbok,4649
+nucliadb_utils/settings.py,sha256=t9fsykZG8b3KcDzvhEVL3upCw14xJ8oehh_mp0SLnmk,5048
 nucliadb_utils/store.py,sha256=kQ35HemE0v4_Qg6xVqNIJi8vSFAYQtwI3rDtMsNy62Y,890
 nucliadb_utils/transaction.py,sha256=l5nbx-GMZvB79rrF2aikvI9yhYHq3WEed4cvFYtW9V8,6633
-nucliadb_utils/utilities.py,sha256=GeQbg4jz-7lUmNVOUoohpAlJB3O8f2crhyBlVrtUQpw,10979
+nucliadb_utils/utilities.py,sha256=vs98HKloeiz2faj0kG_RlCFd7NiDEcHmof6lmUGg3Tk,11309
 nucliadb_utils/audit/__init__.py,sha256=cp15ZcFnHvpcu_5-aK2A4uUyvuZVV_MJn4bIXMa20ks,835
 nucliadb_utils/audit/audit.py,sha256=eZwbTaDHtEAqjtJ34eNuBtv05tK6XfcfcxWeGgOl4Z4,2013
 nucliadb_utils/audit/basic.py,sha256=V6bYvJqP9cvagrvnrYaym0aKpictP0XvL_s34S0YX68,2446
 nucliadb_utils/audit/stream.py,sha256=jZe2VbZ4dR5oRkfOnoOKsmEeQMqcUWMxsjccL7oJCW8,7688
 nucliadb_utils/cache/__init__.py,sha256=vVp-ZPp_aGpofI754T7E9JxsMkATqAEytangiKvE1Nk,900
 nucliadb_utils/cache/exceptions.py,sha256=Zu-O_-0-yctOEgoDGI92gPzWfBMRrpiAyESA62ld6MA,975
 nucliadb_utils/cache/memcache.py,sha256=CWd09BLh0K7vmxmj3Bhh0cLlCVeI_uvkzubqJpK7h0A,1216
@@ -52,16 +52,16 @@
 nucliadb_utils/tests/unit/test_authentication.py,sha256=grPHI9agbyMmsJFm_XhRXmDlKdEtvexvf5QDuuQGzH0,5159
 nucliadb_utils/tests/unit/test_clandestined.py,sha256=pTPcNT5XDWqR1EfmFSdTYpcaEnviXul-hXmL0Sr7wBA,14507
 nucliadb_utils/tests/unit/test_clandestined_collision.py,sha256=j9Y0lUIg4eDa4lSnlm4HAbbPAJiFwpeUbGXGWHBgqWc,1949
 nucliadb_utils/tests/unit/test_clandestined_rendezvous_hash.py,sha256=_H74r3QNKSy-dX6sifC0EpRJIeh1opkDM672UaznXSg,5303
 nucliadb_utils/tests/unit/test_run.py,sha256=VHeojVBj_AfV_uNch9eEi4zCT-O94VKjwb_O-UZgqpA,1910
 nucliadb_utils/tests/unit/test_tests.py,sha256=-YHgVMKJr_3WYwrBj9TnwpVLIkP80PLZpWnvAIYvnz8,1189
 nucliadb_utils/tests/unit/test_transaction.py,sha256=0K09sWCEZ9iFXHYOiPDhS1Vw5F4akyrmboLalwH-B6U,1667
-nucliadb_utils/tests/unit/test_utilities.py,sha256=CGTJnynHU7AfDcF1gclgepB95_j0ycXywMphSEL5cWo,5216
+nucliadb_utils/tests/unit/test_utilities.py,sha256=LO7QVMmx-jpeySJq7kLdyIR-G8fEYAAwHbQ8nioTvGI,5277
 nucliadb_utils/tests/unit/storages/__init__.py,sha256=itSI7dtTwFP55YMX4iK7JzdMHS5CQVUiB1XzQu4UBh8,833
 nucliadb_utils/tests/unit/storages/test_pg.py,sha256=KAIzD3QuJFMRNSSAKz-M5qrO9fJIHYbZfiOOleTgP1c,16726
 nucliadb_utils/tests/unit/storages/test_storage.py,sha256=kgZFXc-y_BX3HlcNHERzAkNPhNilXXQawIHBFq_5Q1k,5638
-nucliadb_utils-2.7.0.post212.dist-info/METADATA,sha256=Hfv7MPJZABZVzBKpGnvp45AY_F0gnlxVk4vpLB1TDG4,1776
-nucliadb_utils-2.7.0.post212.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-nucliadb_utils-2.7.0.post212.dist-info/top_level.txt,sha256=fE3vJtALTfgh7bcAWcNhcfXkNPp_eVVpbKK-2IYua3E,15
-nucliadb_utils-2.7.0.post212.dist-info/zip-safe,sha256=AbpHGcgLb-kRsJGnwFEktk7uzpZOCcBY74-YBdrKVGs,1
-nucliadb_utils-2.7.0.post212.dist-info/RECORD,,
+nucliadb_utils-2.7.0.post213.dist-info/METADATA,sha256=UnB0Xu3nqGkW2w3zQuA_0rxiFcQKFh5v-1IsdLbpa_s,1776
+nucliadb_utils-2.7.0.post213.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+nucliadb_utils-2.7.0.post213.dist-info/top_level.txt,sha256=fE3vJtALTfgh7bcAWcNhcfXkNPp_eVVpbKK-2IYua3E,15
+nucliadb_utils-2.7.0.post213.dist-info/zip-safe,sha256=AbpHGcgLb-kRsJGnwFEktk7uzpZOCcBY74-YBdrKVGs,1
+nucliadb_utils-2.7.0.post213.dist-info/RECORD,,
```

